project_id: land_core

requires_pipelines:
  - pipelines/yanroy/extract_fields.yml
  - pipelines/tiger/state.yml

vars:
  dataset_id: "stage.yanroy_tiles_of_interest_v1"
  name: yanroy.tiles_of_interest
  data_class: STAGE
  dataset_title: "Yanroy Tiles Of Interest By State"
  dataset_notes: "MODIS tile intersections for states.of.interest.csv; used as Yanroy stage metadata."
  catalog_json: ".runs/catalog/catalog.json"
  catalog_repo: "../landcore-data-catalog"
  gdrive_shared_drive_name: "Land Core Risk Model Development"
  gdrive_shared_drive_id: "0AKJcAvvAyp4oUk9PVA"
  gdrive_meta_src: "Data/ETL/Meta"
  gdrive_states_glob: "states.of.interest.csv"
  gdrive_tiles_dst: "Data/ETL/Meta"

dirs:
  workdir: "{env.workdir}/yanroy/tile.of.interest/{sys.now.yymmdd}/{sys.now.hhmmss}-{sys.run.short_id}"
  logdir: "{workdir}/logs"
  metadir: "{workdir}/meta"
  tiger_state_extractdir: "{env.basedir}/data/tiger/state/extract"
  yanroy_metadir: "{env.basedir}/data/yanroy/meta"

steps:
  - name: 01_download_states_of_interest
    plugin: gdrive_download.py
    args:
      rclone_bin: "{env.rclone_bin}"
      src: "{gdrive_meta_src}"
      out: "{metadir}"
      glob: "{gdrive_states_glob}"
      recursive: false
      shared_drive: "{gdrive_shared_drive_name}"
      shared_drive_id: "{gdrive_shared_drive_id}"
    output_var: states_interest

  - name: 02_build_tiles_of_interest
    plugin: exec_script.py
    args:
      script: "scripts/yanroy/build_tiles_of_interest_from_facts.py"
      script_args: "--states-csv \"{states_interest.output_dir}/states.of.interest.csv\" --extract-dir \"{tiger_state_extractdir}\" --raster-facts-csv \"{yanroy_metadir}/raster_facts.csv\" --output-csv \"{metadir}/tiles.of.interest.csv\" --touch-buffer-m 1.0 --verbose"
      verbose: true
    output_var: tiles_builder

  - name: 03_upload_tiles_of_interest
    plugin: gdrive_upload.py
    args:
      rclone_bin: "{env.rclone_bin}"
      input_path: "{metadir}/tiles.of.interest.csv"
      dst: "{gdrive_tiles_dst}"
      shared_drive: "{gdrive_shared_drive_name}"
      shared_drive_id: "{gdrive_shared_drive_id}"
      no_clobber: false
    output_var: tiles_upload

  - name: 04_ai_evidence_tiles_of_interest
    plugin: ai_dataset_evidence_bundle.py
    args:
      dataset_id: "{dataset_id}"
      input_path: "{metadir}/tiles.of.interest.csv"
      output_dir: "{workdir}/ai_context"
      supplemental_urls: "{tiles_upload.output_path}"
      notes: "{dataset_notes}"
    output_var: evidence

  - name: 05_ai_research_tiles_of_interest
    plugin: ai_dataset_research.py
    args:
      dataset_id: "{dataset_id}"
      data_class: "{data_class}"
      title: "{dataset_title}"
      artifact_uri: "{tiles_upload.output_path}"
      sample_file: "{evidence.sample_file}"
      schema_file: "{evidence.schema_file}"
      notes_file: "{evidence.notes_file}"
      supplemental_urls_file: "{evidence.supplemental_urls_file}"
      output_dir: "{workdir}/catalog_ai"
    output_var: catalog_ai

  - name: 06_catalog_json_upsert_tiles_of_interest
    plugin: catalog_json_upsert.py
    args:
      research_file: "{catalog_ai.output_file}"
      catalog_json: "{catalog_json}"
      project_id: land_core
      source_step: ai_research_tiles_of_interest
    output_var: catalog_json_out

  - name: 07_catalog_yaml_sync_tiles_of_interest
    plugin: catalog_yaml_sync.py
    args:
      dataset_id: "{dataset_id}"
      catalog_json: "{catalog_json}"
      catalog_repo: "{catalog_repo}"
      overwrite_managed_fields: false
    output_var: catalog_yaml
