project_id: land_core

requires_pipelines:
  - pipelines/yanroy/tiles_of_interest.yml

vars:
  name: yanroy.google_maps_vector_tiles
  gdrive_shared_drive_name: "Land Core Risk Model Development"
  gdrive_shared_drive_id: "0AKJcAvvAyp4oUk9PVA"
  gdrive_meta_src: "Data/ETL/Meta"
  gdrive_tiles_glob: "tiles.of.interest.csv"
  gdrive_meta_dst: "Data/ETL/GoogleMaps/Poly"
  vector_layer_name: "yanroy_fields"
  min_zoom: 8
  max_zoom: 14

dirs:
  workdir: "{env.workdir}/yanroy/google_maps_vector_tiles/{sys.now.yymmdd}/{sys.now.hhmmss}-{sys.run.short_id}"
  logdir: "{workdir}/logs"
  metadir: "{workdir}/meta"
  yanroy_fieldsdir: "{env.basedir}/data/yanroy/fields"

steps:
  - name: 01_download_tiles_of_interest
    plugin: gdrive_download.py
    args:
      rclone_bin: "{env.rclone_bin}"
      src: "{gdrive_meta_src}"
      out: "{metadir}"
      glob: "{gdrive_tiles_glob}"
      recursive: false
      shared_drive: "{gdrive_shared_drive_name}"
      shared_drive_id: "{gdrive_shared_drive_id}"
    output_var: tiles_interest

  - name: 02_build_field_polygons_ndjson
    plugin: exec_script.py
    args:
      script: "scripts/yanroy/build_field_polygons_ndjson.py"
      script_args: "--tiles-csv \"{tiles_interest.output_dir}/tiles.of.interest.csv\" --fields-dir \"{yanroy_fieldsdir}\" --output-ndjson \"{metadir}/yanroy_fields.ndjson\" --summary-json \"{metadir}/yanroy_fields_polygonize.summary.json\" --verbose"
      verbose: true
    output_var: polygonize

  - name: 03_build_vector_tiles_mbtiles
    plugin: exec_script.py
    args:
      script: "scripts/yanroy/build_vector_tiles_with_tippecanoe.py"
      script_args: "--input-ndjson \"{metadir}/yanroy_fields.ndjson\" --output-mbtiles \"{metadir}/yanroy_fields.mbtiles\" --layer-name \"{vector_layer_name}\" --minimum-zoom {min_zoom} --maximum-zoom {max_zoom} --summary-json \"{metadir}/yanroy_fields.mbtiles.summary.json\" --verbose"
      verbose: true
    output_var: vector_tiles

  - name: 04_upload_vector_tiles_mbtiles
    plugin: gdrive_upload.py
    args:
      rclone_bin: "{env.rclone_bin}"
      input_path: "{metadir}/yanroy_fields.mbtiles"
      dst: "{gdrive_meta_dst}"
      shared_drive: "{gdrive_shared_drive_name}"
      shared_drive_id: "{gdrive_shared_drive_id}"
      no_clobber: false
    output_var: mbtiles_upload

  - name: 05_upload_vector_tiles_summary
    plugin: gdrive_upload.py
    args:
      rclone_bin: "{env.rclone_bin}"
      input_path: "{metadir}/yanroy_fields.mbtiles.summary.json"
      dst: "{gdrive_meta_dst}"
      shared_drive: "{gdrive_shared_drive_name}"
      shared_drive_id: "{gdrive_shared_drive_id}"
      no_clobber: false
    output_var: mbtiles_summary_upload
