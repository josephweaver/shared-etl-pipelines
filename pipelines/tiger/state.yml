project_id: land_core
vars:
  dataset_id: raw.tiger_state_download_v1
  name: tiger_state
  data_class: RAW
  dictionary_repo_key: catalog
  dictionary_source_file: pipelines/tiger/state.dataset.yml
  published_target_uri: gdrive://data/etl/Tiger/States
  tiger_state_url: https://www2.census.gov/geo/tiger/TIGER2025/STATE/tl_2025_us_state.zip
dirs:
  workdir: "{env.workdir}/{name}/{sys.now.yymmdd}/{sys.now.hhmmss}-{sys.run.short_id}"
  logdir: "{workdir}/logs"
  rawdir: "{env.basedir}/data/tiger/state/raw"
  extractdir: "{env.basedir}/data/tiger/state/extract"
steps:
  - name: "{sys.step.NN}_download"
    plugin: web_download_list
    args:
      out: "{rawdir}"
      overwrite: false
      timeout_seconds: 180
      urls: "{tiger_state_url}"
    output_var: staged_raw
  - name: "{sys.step.NN}_unzip"
    plugin: archive_extract
    args:
      archive_glob: "{rawdir}/*.zip"
      out: "{extractdir}"
      overwrite: true
    output_var: extracted_state
  - name: "{sys.step.NN}_vector_facts"
    plugin: vector_facts
    args:
      input_dir: "{extractdir}"
      output_dir: "{workdir}/vector_facts"
    output_var: vector_facts
  - name: "{sys.step.NN}_store"
    plugin: dataset_store
    args:
      dataset_id: "{dataset_id}"
      path: "{extractdir}"
      stage: published
      runtime_context: "{env.executor}"
      location_type: gdrive
      target_uri: "{published_target_uri}"
      owner: "{project.owner}"
      data_class: "{data_class}"
      dry_run: false
    output_var: dataset_store
  - name: "{sys.step.NN}_dictionary_update"
    plugin: dataset_dictionary_pr
    args:
      dataset_id: "{dataset_id}"
      repo_key: "{dictionary_repo_key}"
      source_file: "{dictionary_source_file}"
      file_path: "datasets/raw/{dataset_id}.yml"
      no_pr: false
      no_github_api: false
      dry_run: false
    output_var: dictionary_pr
