project_id: land_core

vars:
  name: prism_county_daily_aggregate_child
  year: 2025
  days: "{expr.daterange(expr.date(year,1,1),expr.date(year,12,31))}"
  prism_filename_prefix: "prism_ppt_us_30s_"
  prism_filename_suffix: ".tif"
  county_path: "{env.basedir}/data/tiger/county/extract/tl_2025_us_county.shp"
  county_id_field: GEOID
  county_name_field: NAME
  value_prefix: ppt
  aggregations: "min,p5,q1,med,avg,q3,p95,max"

dirs:
  workdir: "{env.workdir}/{name}/{year}/{sys.now.yymmdd}/{sys.now.hhmmss}-{sys.run.short_id}"
  logdir: "{workdir}/logs"
  prism_staged_dir: "{env.basedir}/data/prism/ppt/daily/raw"
  outdir: "{workdir}/county_daily"

steps:
  - name: "{sys.step.NN}_county_daily_stats"
    plugin: geo/geo_county_raster_aggregate.py
    args:
      raster_path: "{dirs.prism_staged_dir}/{prism_filename_prefix}{item}{prism_filename_suffix}"
      county_path: "{county_path}"
      output_path: "{dirs.outdir}/county_ppt_{item}.csv"
      county_id_field: "{county_id_field}"
      county_name_field: "{county_name_field}"
      aggregations: "{aggregations}"
      value_prefix: "{value_prefix}"
      day: "{item}"
    sequential_foreach: days
    output_var: county_day

  - name: "{sys.step.NN}_combine_county_daily_stats"
    plugin: combine_files.py
    args:
      input_glob: "{dirs.outdir}/county_ppt_*.csv"
      output_file: "{dirs.outdir}/county_ppt_{year}_daily.csv"
      format: csv
    output_var: county_daily_table
