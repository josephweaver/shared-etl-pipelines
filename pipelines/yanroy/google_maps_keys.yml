project_id: land_core

requires_pipelines:
  - pipelines/yanroy/extract_fields.yml

vars:
  name: yanroy.google_maps_keys
  gdrive_shared_drive_name: "Land Core Risk Model Development"
  gdrive_shared_drive_id: "0AKJcAvvAyp4oUk9PVA"
  gdrive_meta_src: "Data/ETL/Meta"
  gdrive_tiles_glob: "tiles.of.interest.csv"
  gdrive_meta_dst: "Data/ETL/GoogleMaps/Meta"

dirs:
  workdir: "{env.workdir}/yanroy/google_maps_keys/{sys.now.yymmdd}/{sys.now.hhmmss}-{sys.run.short_id}"
  logdir: "{workdir}/logs"
  metadir: "{workdir}/meta"
  yanroy_fieldsdir: "{env.basedir}/data/yanroy/fields"

steps:
  - name: 01_download_tiles_of_interest
    plugin: gdrive_download.py
    args:
      rclone_bin: "{env.rclone_bin}"
      src: "{gdrive_meta_src}"
      out: "{metadir}"
      glob: "{gdrive_tiles_glob}"
      recursive: false
      shared_drive: "{gdrive_shared_drive_name}"
      shared_drive_id: "{gdrive_shared_drive_id}"
    output_var: tiles_interest

  - name: 02_build_google_maps_keys
    plugin: exec_script.py
    args:
      script: "scripts/yanroy/build_google_maps_field_keys.py"
      script_args: "--tiles-csv \"{tiles_interest.output_dir}/tiles.of.interest.csv\" --fields-dir \"{yanroy_fieldsdir}\" --output-csv \"{metadir}/google_maps_field_keys.csv\" --summary-json \"{metadir}/google_maps_field_keys.summary.json\" --verbose"
      verbose: true
    output_var: key_builder

  - name: 03_upload_google_maps_keys_csv
    plugin: gdrive_upload.py
    args:
      rclone_bin: "{env.rclone_bin}"
      input_path: "{metadir}/google_maps_field_keys.csv"
      dst: "{gdrive_meta_dst}"
      shared_drive: "{gdrive_shared_drive_name}"
      shared_drive_id: "{gdrive_shared_drive_id}"
      no_clobber: false
    output_var: keys_csv_upload

  - name: 04_upload_google_maps_keys_summary
    plugin: gdrive_upload.py
    args:
      rclone_bin: "{env.rclone_bin}"
      input_path: "{metadir}/google_maps_field_keys.summary.json"
      dst: "{gdrive_meta_dst}"
      shared_drive: "{gdrive_shared_drive_name}"
      shared_drive_id: "{gdrive_shared_drive_id}"
      no_clobber: false
    output_var: keys_summary_upload
